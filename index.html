// script.js

// —— CONST et STATE —— //
const API_BASE = 'https://api.pokemontcg.io/v2';
let allSets = [],                  // liste des sets
    currentSetIndex = 0,           // index dans allSets pour le carousel
    collection = {},               // { setId: { cardId: { card, count } } }
    wallet = parseFloat(localStorage.getItem('wallet')) || 100;

// —— SÉLECTION DES ÉCRANS —— //
const screens = {
  home:   document.getElementById('screen1'),
  open:   document.getElementById('screen2'),
  col:    document.getElementById('screen3'),
  trade:  document.getElementById('screen4'),
};
const showScreen = name => {
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[name].classList.add('active');
};

// —— HEADER / WALLET —— //
const walletHeader = document.getElementById('walletHeader');
function updateWallet(delta=0){
  wallet = Math.max(0, wallet + delta);
  localStorage.setItem('wallet', wallet.toFixed(2));
  walletHeader.textContent = wallet.toFixed(2) + ' €';
}
updateWallet(0);

// —— NAVIGATION BASSE —— //
document.getElementById('goHome').onclick   = _ => showScreen('home');
document.getElementById('goCollection').onclick = _ => { showCollection(); showScreen('col'); };
document.getElementById('goTrade').onclick  = _ => { renderTrading(); showScreen('trade'); };

// —— FETCH DES SETS —— //
async function loadSets(){
  const res = await fetch(`${API_BASE}/sets`);
  const data = await res.json();
  allSets = data.data;
  renderCarousel();
}
const setsContainer = document.getElementById('setsContainer');
function renderCarousel(){
  setsContainer.innerHTML = '';
  allSets.forEach((s, i) => {
    const btn = document.createElement('div');
    btn.className = 'set-btn';
    btn.style.backgroundImage = `url(${s.images.logo})`;
    const price = document.createElement('div');
    price.className = 'set-price';
    price.textContent = '5 €';
    btn.appendChild(price);
    btn.onclick = _ => openBooster(i);
    setsContainer.appendChild(btn);
  });
}
document.getElementById('prevBtn').onclick = _ => setsContainer.scrollBy({left:-200, behavior:'smooth'});
document.getElementById('nextBtn').onclick = _ => setsContainer.scrollBy({left: 200, behavior:'smooth'});

// —— OUVERTURE DE BOOSTER —— //
const openingArea = document.getElementById('openingArea');
const currentSetName = document.getElementById('currentSetName');
async function openBooster(idx){
  const set = allSets[idx];
  // déduit le prix
  if(wallet < 5) { alert("Portefeuille insuffisant"); return; }
  updateWallet(-5);

  showScreen('open');
  currentSetName.textContent = set.name;
  openingArea.innerHTML = '';

  // 5 cartes aléatoires
  const res = await fetch(`${API_BASE}/cards?q=set.id:${set.id}&pageSize=100`);
  const cards = (await res.json()).data;
  for(let i=0; i<5; i++){
    const c = cards[Math.floor(Math.random()*cards.length)];
    const thumb = document.createElement('div');
    thumb.className = 'card-thumb';
    thumb.style.backgroundImage = `url(${c.images.small})`;
    openingArea.appendChild(thumb);

    // ajoute à la collection
    if(!collection[set.id]) collection[set.id] = {};
    const entry = collection[set.id][c.id] || { card:c, count:0 };
    entry.count++;
    collection[set.id][c.id] = entry;
  }
  localStorage.setItem('collection', JSON.stringify(collection));
}

// —— CLASSEUR —— //
const prevSetBtn = document.getElementById('prevSet');
const nextSetBtn = document.getElementById('nextSet');
const colTitle     = document.getElementById('collectionTitle');
const colArea      = document.getElementById('collectionArea');

function loadCollection(){
  collection = JSON.parse(localStorage.getItem('collection')||'{}');
}
function showCollection(setIdx = 0){
  loadCollection();
  const setIds = Object.keys(collection);
  if(setIds.length===0){
    colTitle.textContent = '— Aucun set —';
    colArea.innerHTML = '';
    return;
  }
  currentSetIndex = Math.max(0,Math.min(setIdx,setIds.length-1));
  const setId = setIds[currentSetIndex];
  const set = allSets.find(s=>s.id===setId);
  colTitle.textContent = set ? set.name : '— Aucun set —';

  // affichage
  colArea.innerHTML = '';
  // on prend le nombre max de cartes du set (ex. 75)
  const total = set.total; 
  for(let num=1; num<=total; num++){
    const slot = document.createElement('div');
    slot.className = 'col-item';

    // placeholder
    const ph = document.createElement('div');
    ph.className = 'placeholder';
    ph.textContent = num.toString().padStart(3,'0');
    slot.appendChild(ph);

    // si on a cette carte
    for(let cid in collection[setId]){
      const e = collection[setId][cid];
      if(Number(e.card.number)===num){
        slot.innerHTML = ''; // remplace placeholder
        const img = document.createElement('img');
        img.src = e.card.images.small;
        slot.appendChild(img);
        const del = document.createElement('div');
        del.className = 'delete-btn';
        del.textContent = '✕';
        del.onclick = _ => {
          if(confirm('Supprimer cette carte ?')){
            e.count--;
            if(e.count<=0) delete collection[setId][cid];
            localStorage.setItem('collection', JSON.stringify(collection));
            showCollection(currentSetIndex);
          }
        };
        slot.appendChild(del);
        const badge = document.createElement('span');
        badge.textContent = 'x'+e.count;
        slot.appendChild(badge);
      }
    }
    colArea.appendChild(slot);
  }
}
prevSetBtn.onclick = _ => showCollection(currentSetIndex-1);
nextSetBtn.onclick = _ => showCollection(currentSetIndex+1);

// —— MODAL AGRANDI —— //
const cardModal = document.getElementById('cardModal');
const modalImg  = document.getElementById('modalImg');
document.body.addEventListener('click', e => {
  if(e.target.tagName==='IMG' && e.target.parentNode.id==='collectionArea'){
    modalImg.src = e.target.src.replace('/small/','/large/');
    cardModal.style.display = 'flex';
  }
});
cardModal.onclick = _ => cardModal.style.display = 'none';

// —— TRADING (stub) —— //
function renderTrading(){
  document.getElementById('offers').textContent   = 'Chargement…';
  document.getElementById('myOffers').textContent = 'Aucune carte à vendre.';
  // ici tu peux programmer fetch vers ton back-end / générer aléa…
}
setInterval(_=>{ if(screens.trade.classList.contains('active')) renderTrading() }, 300000);

// —— INITIALISATION —— //
window.addEventListener('load', async() => {
  // recup collec
  loadCollection();
  // load sets & afficher
  await loadSets();
});
